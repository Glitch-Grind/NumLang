<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NumLang Editor</title>

<style>
@font-face {
    font-family: "JetBrainsMono";
    src: url("fonts/JetBrainsMono-Regular.woff2") format("woff2");
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    background: #0f111a;
    overflow: hidden;
    font-family: "JetBrainsMono", Consolas, monospace;
}

/* UI Panel */
#ui {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 360px;
    z-index: 1000;
}

#ui-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

#ui-title {
    color: #c0caf5;
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    flex: 1;
}

button {
    background: linear-gradient(135deg, #7aa2f7 0%, #89b4fa 100%);
    border: none;
    color: #0f111a;
    padding: 10px 20px;
    font-family: "JetBrainsMono", Consolas, monospace;
    cursor: pointer;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(122, 162, 247, 0.3);
    position: relative;
    overflow: hidden;
}

button:hover {
    background: linear-gradient(135deg, #89b4fa 0%, #a5c9ff 100%);
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(122, 162, 247, 0.4);
}

button:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(122, 162, 247, 0.3);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

button.running::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid #0f111a;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

#output-container {
    background: #1a1b26;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    overflow: hidden;
    border: 1px solid rgba(192, 202, 245, 0.1);
}

#output-header {
    background: rgba(26, 27, 38, 0.8);
    padding: 10px 16px;
    border-bottom: 1px solid rgba(192, 202, 245, 0.1);
    display: flex;
    align-items: center;
    gap: 8px;
}

#output-header::before {
    content: '▶';
    color: #7aa2f7;
    font-size: 10px;
}

#output-label {
    color: #c0caf5;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}

pre {
    background: #1a1b26;
    color: #c0caf5;
    padding: 16px;
    margin: 0;
    height: 240px;
    overflow-y: auto;
    font-size: 13px;
    line-height: 1.6;
    font-family: "JetBrainsMono", Consolas, monospace;
}

pre::-webkit-scrollbar {
    width: 8px;
}

pre::-webkit-scrollbar-track {
    background: rgba(26, 27, 38, 0.5);
}

pre::-webkit-scrollbar-thumb {
    background: rgba(192, 202, 245, 0.2);
    border-radius: 4px;
}

pre::-webkit-scrollbar-thumb:hover {
    background: rgba(192, 202, 245, 0.3);
}

pre.error {
    color: #f7768e;
}

pre.success {
    color: #9ece6a;
}

canvas {
    display: block;
    outline: none;
    cursor: text;
}

canvas:focus {
    outline: none;
}

/* Responsive */
@media (max-width: 768px) {
    #ui {
        width: calc(100% - 40px);
        max-width: 360px;
    }
}
</style>
</head>

<body>

<div id="ui">
    <div id="ui-header">
        <h3 id="ui-title">NumLang Editor</h3>
        <button id="run-button" onclick="runCode()">▶ Run</button>
    </div>
    <div id="output-container">
        <div id="output-header">
            <span id="output-label">Output</span>
        </div>
        <pre id="output">Ready. Click Run to execute your code.</pre>
    </div>
</div>

<canvas id="editor" tabindex="0"></canvas>

<script>
const canvas = document.getElementById("editor");
const ctx = canvas.getContext("2d");

let lines = [""];
let cursorX = 0;
let cursorY = 0;
let showCaret = true;

const fontSize = 16;
const lineHeight = 24;
const padding = 60;

function setFont() {
    ctx.font = fontSize + "px JetBrainsMono, Consolas, monospace";
    ctx.textBaseline = "top";
    ctx.textAlign = "left";
}

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    setFont(); // Reset font after canvas resize (context is reset)
    draw();
}

function draw() {
    ctx.fillStyle = "#0f111a";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    lines.forEach((line, i) => {
        const y = i * lineHeight + 4; // Top baseline, add small padding

        // Line numbers
        ctx.fillStyle = "#3b4261";
        ctx.fillText((i + 1).toString(), 20, y);

        drawHighlightedText(line, padding, y);
    });

    if (showCaret) drawCaret();
}

function drawHighlightedText(text, x, y) {
    const tokens = text.split(/(\s+)/);
    let offsetX = x;

    tokens.forEach(token => {
        ctx.fillStyle = getTokenColor(token);
        ctx.fillText(token, offsetX, y);
        offsetX += ctx.measureText(token).width;
    });
}

function getTokenColor(token) {
    if (/^\d+(\.\d+)?$/.test(token)) return "#89ddff";
    if (/^(let|print)$/.test(token)) return "#c792ea";
    if (/^(sqrt|sin|cos|tan|log)$/.test(token)) return "#82aaff";
    if (/^[=+\-*/^()]+$/.test(token)) return "#ffcb6b";
    return "#d4d4d4";
}

function drawCaret() {
    const textBeforeCursor = lines[cursorY].slice(0, cursorX);
    const x = padding + ctx.measureText(textBeforeCursor).width;
    const y = cursorY * lineHeight + 4; // Match text y position

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(x, y, 2, fontSize);
}

/* Blinking caret */
setInterval(() => {
    showCaret = !showCaret;
    draw();
}, 500);

document.addEventListener("keydown", e => {
    // Ignore keyboard events if user is typing in an input field
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.isContentEditable) {
        return;
    }
    
    // Focus canvas if it's not focused
    if (document.activeElement !== canvas) {
        canvas.focus();
    }
    
    const line = lines[cursorY];

    if (e.key === "Backspace") {
        if (cursorX > 0) {
            lines[cursorY] =
                line.slice(0, cursorX - 1) +
                line.slice(cursorX);
            cursorX--;
        } 
        else if (cursorY > 0) {
            cursorX = lines[cursorY - 1].length;
            lines[cursorY - 1] += line;
            lines.splice(cursorY, 1);
            cursorY--;
        }
    }

    else if (e.key === "Enter") {
        const newLine = line.slice(cursorX);
        lines[cursorY] = line.slice(0, cursorX);
        lines.splice(cursorY + 1, 0, newLine);

        cursorY++;
        cursorX = 0;
    }

    else if (e.key === "ArrowLeft") {
        if (cursorX > 0) cursorX--;
        else if (cursorY > 0) {
            cursorY--;
            cursorX = lines[cursorY].length;
        }
    }

    else if (e.key === "ArrowRight") {
        if (cursorX < line.length) cursorX++;
        else if (cursorY < lines.length - 1) {
            cursorY++;
            cursorX = 0;
        }
    }

    else if (e.key === "ArrowUp") {
        if (cursorY > 0) {
            cursorY--;
            cursorX = Math.min(cursorX, lines[cursorY].length);
        }
    }

    else if (e.key === "ArrowDown") {
        if (cursorY < lines.length - 1) {
            cursorY++;
            cursorX = Math.min(cursorX, lines[cursorY].length);
        }
    }

    else if (e.key.length === 1) {
        lines[cursorY] =
            line.slice(0, cursorX) +
            e.key +
            line.slice(cursorX);

        cursorX++;
    }

    draw();
});

/* Run Button Logic */
function runCode() {
    const code = lines.join("\n");
    const runButton = document.getElementById("run-button");
    const output = document.getElementById("output");
    
    // Disable button and show loading state
    runButton.disabled = true;
    runButton.classList.add("running");
    runButton.textContent = "Running";
    output.textContent = "Running code...";
    output.className = "";
    
    fetch("http://localhost:5000/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: code })
    })
    .then(res => res.text())
    .then(result => {
        output.textContent = result;
        output.className = "success";
    })
    .catch(err => {
        output.textContent = "Error connecting to server: " + err;
        output.className = "error";
    })
    .finally(() => {
        // Re-enable button
        runButton.disabled = false;
        runButton.classList.remove("running");
        runButton.textContent = "▶ Run";
    });
}

// Initialize canvas and event listeners
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// Focus canvas on click and on page load
canvas.addEventListener("click", () => {
    canvas.focus();
});

// Focus canvas when page loads
window.addEventListener("load", () => {
    canvas.focus();
    draw(); // Ensure initial draw
});
</script>

</body>
</html>
